!function(){"use strict";console.log("üü¢ client.js loaded"),document.addEventListener("DOMContentLoaded",()=>{let e=sessionStorage.getItem("bc_username");e||(e=prompt("Enter display name:")?.trim()||"Guest"+Math.floor(1e3*Math.random()),sessionStorage.setItem("bc_username",e)),document.getElementById("user-label").textContent=e;let t=sessionStorage.getItem("bc_room");t||(t=prompt("Enter room name:")?.trim().toLowerCase(),sessionStorage.setItem("bc_room",t)),document.getElementById("room-label").textContent=t;let n=[];const o=io();window.chatSocket=o;const s=document.getElementById("embed-player"),c=document.getElementById("user-list"),a=document.getElementById("force-play-next"),r=document.getElementById("chat-messages"),i=document.getElementById("change-name"),l=document.getElementById("send"),m=document.getElementById("message"),d=document.getElementById("request-form"),u=document.getElementById("request-input"),p=document.getElementById("queue-list"),h=document.getElementById("next-up-preview"),f=document.getElementById("play-next"),g=document.getElementById("theme-toggle"),y=new Set,b=document.getElementById("change-room");d.addEventListener("submit",t=>{t.preventDefault();const n=u.value.trim();if(!n)return alert("Paste a URL or <iframe> snippet.");o.emit("request track",{url:n,requestedBy:e}),u.value=""});let w=!0;function v(e){const t=document.createElement("div");t.className="user-action",t.textContent=e,r.append(t),r.scrollTop=r.scrollHeight}function E(e){const t=e.trim();if(/^<iframe[^>]+bandcamp\.com\/EmbeddedPlayer/.test(t))return`<div class="embed-container">${t}</div>`;if(/^https?:\/\/[^\/]+\.bandcamp\.com\/(?:track|album)\//.test(t)){const e=t.split("?")[0];return`\n      <div class="embed-container">\n        <iframe\n          style="border:0;width:100%;height:470px;"\n          src="${["https://bandcamp.com/EmbeddedPlayer/","url="+encodeURIComponent(e),"/size=large","/bgcol=ffffff","/linkcol=0687f5","/transparent=true"].join("")}"\n          seamless>\n        </iframe>\n      </div>\n    `.trim()}if(/^<iframe/i.test(t))return`<div class="embed-container">${t}</div>`;if(/^https?:\/\/(soundcloud\.com|snd\.sc)\//.test(t)){const e=t.split("?")[0];return`<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="${["https://w.soundcloud.com/player/","?url="+encodeURIComponent(e),"&color=%23ff5500","&auto_play=false","&hide_related=false","&show_comments=true","&show_user=true","&show_reposts=false"].join("")}"></iframe>`}const n=t.match(/^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_-]{11})/);if(n)return`<iframe\n              width="560" height="315"\n              src="https://www.youtube.com/embed/${n[1]}"\n              frameborder="0"\n              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"\n              allowfullscreen>\n            </iframe>`;const o=t.match(/open\.spotify\.com\/(track|album|playlist)\/([A-Za-z0-9]+)/);if(o)return`<iframe\n              src="https://open.spotify.com/embed/${o[1]}/${o[2]}"\n              width="300" height="380"\n              frameborder="0"\n              allowtransparency="true"\n              allow="encrypted-media">\n            </iframe>`;if(/mixcloud\.com\//.test(t)){const e=t.split("?")[0].replace(/\/?$/,"/");return`<iframe\n              width="100%" height="120"\n              src="https://www.mixcloud.com/widget/iframe/?feed=${encodeURIComponent(e)}"\n              frameborder="0">\n            </iframe>`}return`<div>Unsupported URL: <a href="${t}" target="_blank">${t}</a></div>`}o.emit("join",t,e),o.on("name taken",n=>{const s=w;let c;do{c=prompt(`"${n}" is taken‚Äîchoose another:`)?.trim()||"Guest"+Math.floor(1e3*Math.random())}while(c===n);const a=e;e=c,sessionStorage.setItem("bc_username",e),document.getElementById("user-label").textContent=e,s?o.emit("join",t,e):o.emit("name change",{oldName:a,newName:e})}),o.on("room users",t=>{c.innerHTML="",t.forEach(t=>{const s=document.createElement("li");s.style.display="flex",s.style.alignItems="center";const a=document.createElement("span");if(a.textContent=t+(n.includes(t)?" ‚òÖ":""),a.style.flexGrow="1",s.appendChild(a),n.includes(e)&&t!==e){const e=document.createElement("button");e.textContent="‚õî",e.title="Ban user",e.className="action-btn",e.onclick=()=>o.emit("ban user",t),s.appendChild(e);const n=document.createElement("button");n.textContent="üëü",n.title="Kick user",n.className="action-btn",n.onclick=()=>o.emit("kick user",t),s.appendChild(n)}if(t!==e&&!n.includes(t)){const e=document.createElement("button");e.textContent=y.has(t)?"üòå":"üòí",e.title=y.has(t)?"Unignore user":"Ignore user",e.className="action-btn",e.onclick=()=>{y.has(t)?y.delete(t):y.add(t),e.textContent=y.has(t)?"üòå":"üòí",e.title=y.has(t)?"Unignore user":"Ignore user"},s.appendChild(e)}c.appendChild(s)})}),o.on("room mods",t=>{n=t,b.style.display=n.includes(e)?"inline-block":"none",o.emit("request users")}),b.addEventListener("click",()=>{const e=t,n=prompt("Enter a new room name:",t);if(!n)return;const s=n.trim().toLowerCase();s!==t&&(t=s,sessionStorage.setItem("bc_room",t),document.getElementById("room-label").textContent=t,o.emit("change room",{oldRoom:e,newRoom:s}))}),o.on("user joined",e=>v(`${e} just entered the chat`)),o.on("user left",e=>v(`${e} has left the chat`)),o.on("name change",({oldName:t,newName:n})=>{e===t&&(e=n,sessionStorage.setItem("bc_username",n),document.getElementById("user-label").textContent=n),v(`${t} is now known as ${n}`)}),o.on("user action",async({type:e,username:t,url:n})=>{const o=await async function(e){const t=e.trim();if(/^(?:https?:\/\/)?(?:www\.)?soundcloud\.com\//.test(t))try{const e=await fetch("https://soundcloud.com/oembed?format=json&url="+encodeURIComponent(t.split("?")[0]));if(e.ok){const{title:t}=await e.json();return t}}catch{}if(/^(?:https?:\/\/)?(?:www\.)?mixcloud\.com\//.test(t)){const e=t.split("?")[0].match(/^https?:\/\/(?:www\.)?mixcloud\.com\/([^\/]+)\/([^\/]+)\/?/);if(e){const t=e[1],n=e[2];try{const e=await fetch(`https://api.mixcloud.com/${t}/${n}/?metadata=1`);if(e.ok){const t=await e.json();return`${t.user.name} ‚Äì ${t.name}`}}catch{}}try{const e=t.endsWith("/")?t:t+"/",n=await fetch("https://api.mixcloud.com/oembed?format=json&url="+encodeURIComponent(e));if(n.ok)return(await n.json()).title}catch{}}if(/^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)/.test(t))try{const e=await fetch("https://www.youtube.com/oembed?format=json&url="+encodeURIComponent(t));if(e.ok){const{title:t}=await e.json();return t}}catch{}if(/^https?:\/\/open\.spotify\.com\/(track|album|playlist)\//.test(t))try{const e=await fetch("https://open.spotify.com/oembed?format=json&url="+encodeURIComponent(t.split("?")[0]));if(e.ok){const{title:t}=await e.json();return t}}catch{}const n=t.split("/").filter(Boolean).pop().replace(/[-_]+/g," ");return n.charAt(0).toUpperCase()+n.slice(1)}(n),s=document.createElement("div");s.className="user-action",s.textContent=`${t} ${"upvote"===e?"upvoted":"downvoted"} ‚Äú${o}‚Äù`,r.append(s),r.scrollTop=r.scrollHeight}),o.on("error",e=>{const t=document.createElement("div");t.className="user-action",t.textContent=`Error: ${e}`,r.append(t),r.scrollTop=r.scrollHeight}),i.addEventListener("click",()=>{const t=e,n=prompt("New display name:",t)?.trim();n&&n!==t&&(w=!1,o.emit("name change",{oldName:t,newName:n}))}),l.addEventListener("click",()=>{const t=m.value.trim();t&&(o.emit("chat message",{text:t,username:e}),m.value="")}),o.on("chat message",({text:e,username:t,timestamp:n})=>{if(y.has(t))return;const o=document.createElement("div");o.textContent=`${t}: ${e}`,r.append(o),r.scrollTop=r.scrollHeight});let k=[];o.on("queue updated",t=>{k=t,p.innerHTML="",t.slice().reverse().forEach((n,s)=>{const c=t.length-1-s,a=document.createElement("li");a.innerHTML=`\n  <div class="vote-controls">\n    <strong>${n.votes} votes</strong>\n    <button class="up">üëç</button>\n    <button class="dn">üëé</button>\n  </div>\n  <div class="embed-container">\n    ${E(n.url)}\n  </div>\n  <div class="requested-by">Requested by: ${n.requestedBy}</div>\n`,a.querySelector(".up").onclick=()=>o.emit("vote track",{idx:c,username:e}),a.querySelector(".dn").onclick=()=>o.emit("downvote track",{idx:c,username:e}),p.append(a)}),t.length?(h.innerHTML=`\n  <div class="embed-container">\n    ${E(k.reduce((e,t)=>t.votes>e.votes?t:e,k[0]).url)}\n  </div>\n`,f.disabled=!1):(h.innerHTML="<em>No suggestions yet</em>",f.disabled=!0)}),f.addEventListener("click",()=>{k.length&&o.emit("play track",{url:k.reduce((e,t)=>t.votes>e.votes?t:e,k[0]).url})}),a.addEventListener("click",()=>{k.length&&o.emit("force play track",{url:k.reduce((e,t)=>t.votes>e.votes?t:e,k[0]).url})}),o.on("play track at",({url:e})=>{s.innerHTML=E(e);const t=document.createElement("div");t.className="play-overlay",t.textContent="‚ñ∂ Play Track",s.appendChild(t),t.addEventListener("click",()=>{t.remove();const e=s.querySelector("iframe");e&&e.src.includes("soundcloud.com")&&SC.Widget(e).play()});const n=s.querySelector("iframe");if(n&&n.src.includes("soundcloud.com")){const e=SC.Widget(n);e.unbind(SC.Widget.Events.FINISH),e.bind(SC.Widget.Events.FINISH,()=>o.emit("track ended"))}}),g.addEventListener("click",()=>{const e=document.body.classList.toggle("dark");localStorage.setItem("bc_theme",e?"dark":"light")}),"dark"===localStorage.getItem("bc_theme")&&document.body.classList.add("dark")});const e=document.getElementById("sidebar-toggle"),t=document.querySelector(".sidebar"),n=document.querySelector("main");e.addEventListener("click",()=>{t.classList.toggle("open"),n.classList.toggle("shifted")})}();
